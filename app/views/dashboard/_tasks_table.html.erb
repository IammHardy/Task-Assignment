<!-- app/views/dashboard/_tasks_table.html.erb -->

<turbo-frame id="tasks_table">
<div class="overflow-x-auto">
  <!-- Tasks Table -->
<div class="mb-8 bg-white shadow rounded-lg p-6 border border-gray-200">
  <h2 class="text-2xl font-semibold mb-4">Tasks</h2>
  <thead class="bg-gray-100">
  <tr>
    <th class="border px-4 py-2">Title</th>
    <th class="border px-4 py-2">Employee</th>
    <th class="border px-4 py-2">Status</th>
    <th class="border px-4 py-2">Manager</th>
    <% if @active_view == "employee" %>
      <th class="border px-4 py-2">Actions</th>
    <% end %>
  </tr>
</thead>

<tbody>
  <% @tasks_to_show.each do |task| %>
    <%= turbo_frame_tag "task_#{task.id}" do %>
      <tr class="<%= task.status == 'completed' ? 'bg-green-50' : task.status == 'overdue' ? 'bg-red-50' : '' %>">
        <td class="border px-4 py-2"><%= task.title %></td>
        <td class="border px-4 py-2"><%= task.user.name %></td>
        <td class="border px-4 py-2"><%= task.status.capitalize %></td>
        <td class="border px-4 py-2"><%= task.user.manager&.name || "Unassigned" %></td>
        <td class="border px-4 py-2">
          <% if @active_view == "employee" && task.status != "completed" %>
            <%= button_to "Mark Complete",
                  mark_complete_dashboard_index_path(id: task.id),
                  method: :patch,
                  form: { data: { turbo_frame: "task_#{task.id}" } },
                  class: "bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded" %>
          <% elsif task.status == "completed" %>
            <span class="text-green-700 font-semibold">Completed</span>
          <% end %>
        </td>
      </tr>
    <% end %>
  <% end %>
</tbody>


</div>

<!-- Create Task Form -->
<% if @active_view.in?(["admin", "manager"]) %>
  <div class="mb-8 bg-white shadow rounded-lg p-6 border border-gray-200">
    <h2 class="text-2xl font-semibold mb-4">Create Task</h2>
    <%= form_with model: @task || OpenStruct.new(title: "", user_id: nil), url: "#", local: true do |f| %>
      <div class="mb-2">
        <%= f.label :title %>
        <%= f.text_field :title, class: "border rounded px-2 py-1 w-full" %>
      </div>
      <div class="mb-2">
        <%= f.label :assign_to, "Assign to Employee" %>
        <%= f.select :user_id, options_from_collection_for_select(@employees, :id, :name), { prompt: "Select Employee" }, class: "border rounded px-2 py-1 w-full" %>
      </div>
      <%= f.submit "Create Task", class: "bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" %>
    <% end %>
  </div>
<% end %>

</div>
</turbo-frame>
